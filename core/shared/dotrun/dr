#!/usr/bin/env bash

# shellcheck disable=SC2155
# shellcheck disable=SC1091
# shellcheck disable=SC2016
# Strict error handling
set -euo pipefail

IFS=$'\n\t'

DOC_TOKEN="### DOC"

# Version - Read from VERSION file or fallback to 3.1.1
# Resolve symlinks to find the actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

if [[ -f "$SCRIPT_DIR/VERSION" ]]; then
  DRUN_VERSION="$(cat "$SCRIPT_DIR/VERSION")"
else
  DRUN_VERSION="3.1.1"  # Fallback if VERSION file not found
fi


_default_editor="$(command -v code >/dev/null && echo "code" || echo "nano")"
EDITOR="${EDITOR:-$_default_editor}"

# Validate EDITOR environment variable
if [[ -n "$EDITOR" ]] && ! command -v "$EDITOR" >/dev/null 2>&1; then
  echo "Warning: EDITOR '$EDITOR' not found in PATH, falling back to $_default_editor" >&2
  EDITOR="$_default_editor"
fi

# SHARED Configurations (must be defined before sourcing constants.sh)
SHARED_DR_PATH="${HOME}/.local/share/dotrun"
SHARED_DR_CORE_PATH="${SHARED_DR_PATH}/core"
SHARED_DR_HELPERS_PATH="${SHARED_DR_PATH}/helpers"

# Source constants.sh for paths, icons, and colors (single source of truth)
SHARED_DR_HELPERS_CONSTANTS="${SHARED_DR_HELPERS_PATH}/constants.sh"
if [[ -f "$SHARED_DR_HELPERS_CONSTANTS" ]]; then
  # shellcheck disable=SC1090
  source "$SHARED_DR_HELPERS_CONSTANTS"
fi

# Ensure user collection directories exist
mkdir -p "$USER_COLLECTION_SCRIPTS"
mkdir -p "$USER_COLLECTION_HELPERS"

# Core system paths (depend on SCRIPT_DIR, must stay here)
SHARED_DR_CORE_SCRIPTS="$SCRIPT_DIR/core/scripts.sh"
SHARED_DR_CORE_ALIASES="$SCRIPT_DIR/core/aliases.sh"
SHARED_DR_CORE_CONFIGS="$SCRIPT_DIR/core/config.sh"
SHARED_DR_CORE_COLLECTIONS="$SCRIPT_DIR/core/collections.sh"

# Helper paths
SHARED_DR_HELPERS_LINT="${SHARED_DR_HELPERS_PATH}/lint.sh"
SHARED_DR_HELPERS_LIST_TREE="${SHARED_DR_HELPERS_PATH}/list_feature_files_tree.sh"

# Templates
SHARED_DR_TEMPLATES_PATH="${SHARED_DR_CORE_PATH}/templates"
TEMPLATE_NEW_SCRIPT="${SHARED_DR_TEMPLATES_PATH}/script.sh"

# Help messages
SHARED_DR_HELP_MESSAGES_PATH="$SCRIPT_DIR/core/help-messages"

# Source lint helper (small, frequently used)
# shellcheck disable=SC1090
[[ -f "$SHARED_DR_HELPERS_LINT" ]] && source "$SHARED_DR_HELPERS_LINT"

# Lazy-load module functions (source only when needed)
_load_scripts_module() {
  if [[ $(type -t set_script) != "function" ]]; then
    # shellcheck disable=SC1090
    [[ -f "$SHARED_DR_CORE_SCRIPTS" ]] && source "$SHARED_DR_CORE_SCRIPTS"
  fi
}

_load_aliases_module() {
  if [[ $(type -t aliases_set) != "function" ]]; then
    # shellcheck disable=SC1090
    [[ -f "$SHARED_DR_CORE_ALIASES" ]] && source "$SHARED_DR_CORE_ALIASES"
  fi
}

_load_configs_module() {
  if [[ $(type -t config_set) != "function" ]]; then
    # shellcheck disable=SC1090
    [[ -f "$SHARED_DR_CORE_CONFIGS" ]] && source "$SHARED_DR_CORE_CONFIGS"
  fi
}

_load_collections_module() {
  if [[ $(type -t cmd_col_list) != "function" ]]; then
    # shellcheck disable=SC1090
    [[ -f "$SHARED_DR_CORE_COLLECTIONS" ]] && source "$SHARED_DR_CORE_COLLECTIONS"
  fi
}

# Main command parser
case "${1:-}" in
-r|reload)
  # Feature-agnostic reload command
  drrc="$HOME/.drrc"

  if [[ ! -f "$drrc" ]]; then
    echo -e "${COLOR_SCRIPTS}Error:${COLOR_RESET} ~/.drrc not found" >&2
    echo "DotRun may not be properly installed or initialized." >&2
    exit 1
  fi

  exec "$SHARED_DR_HELP_MESSAGES_PATH/core/reload.sh"
  ;;
-l | -L)
  _load_scripts_module
  show_docs=0
  [[ "$1" == "-L" ]] && show_docs=1
  scope="${2:-}" # optional second arg
  list_scripts "$show_docs" "$scope"
  ;;
-s|scripts)
  # Script management namespace
  _load_scripts_module
  case "${2:-}" in
  set)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr $1 set <name>"
      exit 1
    }
    set_script "$3"
    ;;
  move|rename)
    [[ -z "${3:-}" || -z "${4:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/scripts/move.sh" "$1"
    }
    move_script "$3" "$4"
    ;;
  help)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr $1 help <name>"
      exit 1
    }
    show_script_help "$3"
    ;;
  rm)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr $1 rm <name>"
      exit 1
    }
    remove_script "$3"
    ;;
  list)
    # Optional folder scope for list
    show_docs=0
    scope="${3:-}"
    list_scripts "$show_docs" "$scope"
    ;;
  *)
    exec "$SHARED_DR_HELP_MESSAGES_PATH/scripts/no-args.sh" "$1"
    ;;
  esac
  ;;
set)
  _load_scripts_module
  [[ -z "${2:-}" ]] && {
    echo "Usage: dr set <name>"
    exit 1
  }
  set_script "$2"
  ;;
move | rename | mv)
  _load_scripts_module
  [[ -z "${2:-}" || -z "${3:-}" ]] && {
    exec "$SHARED_DR_HELP_MESSAGES_PATH/scripts/move.sh" "$1"
  }
  move_script "$2" "$3"
  ;;
help)
  _load_scripts_module
  [[ -z "${2:-}" ]] && {
    echo "Usage: dr help <name>"
    exit 1
  }
  show_script_help "$2"
  ;;
docs)
  _load_scripts_module
  [[ -z "${2:-}" ]] && {
    echo "Usage: dr docs <name>"
    exit 1
  }
  show_script_help "$2"
  ;;
rm)
  _load_scripts_module
  [[ -z "${2:-}" ]] && {
    echo "Usage: dr rm <name>"
    exit 1
  }
  remove_script "$2"
  ;;
-col|collections)
  _load_collections_module
  if [[ $(type -t cmd_col_init) != "function" ]]; then
    echo "Error: Collections helper not available" >&2
    exit 1
  fi
  case "${2:-}" in
  "")
    # No arguments - run interactive browser
    cmd_col_interactive
    ;;
  init)
    cmd_col_init
    ;;
  add)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr $1 add <github-url>"
      echo "Example: dr $1 add https://github.com/user/repo"
      exit 1
    }
    cmd_col_add "$3"
    ;;
  list)
    cmd_col_list
    ;;
  sync)
    cmd_col_sync
    ;;
  update)
    # Allow both interactive (no args) and direct (with name) modes
    cmd_col_update "${3:-}"
    ;;
  remove)
    [[ -z "${3:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/collections/remove.sh"
    }
    cmd_col_remove "$3"
    ;;
  --help|-h|help)
    exec "$SHARED_DR_HELP_MESSAGES_PATH/collections/help-message.sh"
    ;;
  *)
    exec "$SHARED_DR_HELP_MESSAGES_PATH/collections/no-args.sh" "$1"
    ;;
  esac
  ;;
-a|aliases)
  _load_aliases_module
  if [[ $(type -t aliases_init) != "function" ]]; then
    echo "Error: Aliases helper not available" >&2
    exit 1
  fi

  # Handle -l and -L flags first (before case statement)
  if [[ "${2:-}" == "-l" ]]; then
    list_aliases 0 "${3:-}"
    exit 0
  elif [[ "${2:-}" == "-L" ]]; then
    list_aliases 1 "${3:-}"
    exit 0
  fi

  case "${2:-}" in
  init)
    aliases_init
    ;;
  set)
    [[ -z "${3:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/aliases/set.sh"
    }
    aliases_set "$3"
    ;;
  remove | rm)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr aliases rm <name>"
      exit 1
    }
    aliases_remove "$3"
    ;;
  help)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr aliases help <name>" >&2
      exit 1
    }
    aliases_help "$3"
    ;;
  move)
    [[ -z "${3:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/aliases/move.sh"
    }
    aliases_move "$3" "${4:-}"
    ;;
  *)
    # Default action: if argument doesn't start with - and is not empty, treat as filename
    if [[ -n "${2:-}" && "${2:0:1}" != "-" ]]; then
      aliases_set "$2"
    else
      exec "$SHARED_DR_HELP_MESSAGES_PATH/aliases/no-args.sh"
    fi
    ;;
  esac
  ;;
-c|config)
  _load_configs_module
  if [[ $(type -t config_set) != "function" ]]; then
    echo "Error: Config helper not available" >&2
    exit 1
  fi
  # Handle -l and -L flags first (before case statement)
  if [[ "${2:-}" == "-l" ]]; then
    list_configs 0 "${3:-}"
    exit 0
  elif [[ "${2:-}" == "-L" ]]; then
    list_configs 1 "${3:-}"
    exit 0
  fi
  case "${2:-}" in
  set)
    [[ -z "${3:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/configs/set.sh"
    }
    config_set "$3"
    ;;
  list)
    show_categories="false"
    filter_category=""
    # Check for flags
    if [[ "${3:-}" == "--categories" ]]; then
      show_categories="true"
    elif [[ "${3:-}" == "--category" && -n "${4:-}" ]]; then
      filter_category="$4"
    fi
    config_list "$show_categories" "$filter_category"
    ;;
  move)
    [[ -z "${3:-}" ]] && {
      exec "$SHARED_DR_HELP_MESSAGES_PATH/configs/move.sh"
    }
    config_move "$3" "${4:-}"
    ;;
  help)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr config help <name>" >&2
      exit 1
    }
    config_help "$3"
    ;;
  remove | rm)
    [[ -z "${3:-}" ]] && {
      echo "Usage: dr config rm <name>"
      exit 1
    }
    config_remove "$3"
    ;;
  init)
    # Initialize config folder structure
    config_dir="${DR_CONFIG:-$HOME/.config/dotrun}/configs"
    if [[ ! -d "$config_dir" ]]; then
      mkdir -p "$config_dir"
      echo "âœ“ Created configs directory: $config_dir"
    else
      echo "Configs directory already exists: $config_dir"
    fi
    ;;
  "")
    # Show help when no arguments
    exec "$SHARED_DR_HELP_MESSAGES_PATH/configs/no-args.sh"
    ;;
  -*)
    # Unknown flag
    echo "Error: Unknown flag ${2}" >&2
    exit 1
    ;;
  *)
    # Default action: if argument doesn't start with - and is not empty, treat as filename
    if [[ -n "${2:-}" && "${2:0:1}" != "-" ]]; then
      config_set "$2"
    else
      exec "$SHARED_DR_HELP_MESSAGES_PATH/configs/no-args.sh"
    fi
    ;;
  esac
  ;;
-v | --version | version)
  echo "dr version $DRUN_VERSION"
  exit 0
  ;;
"" | -h | --help)
  exec "$SHARED_DR_HELP_MESSAGES_PATH/core/help-message.sh"
  ;;
*)
  if [[ -n "${1:-}" ]]; then
    _load_scripts_module
    run_script "$@"
  else
    exec "$SHARED_DR_HELP_MESSAGES_PATH/core/no-command.sh" >&2
    exit 1
  fi
  ;;
esac
