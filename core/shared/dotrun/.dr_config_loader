#!/usr/bin/env bash

# DotRun Configuration
# This file is managed by DotRun. Manual edits may be overwritten.
# Use 'dr config set/get/unset' commands to manage configuration.

#* =================== SHELL CONFIGURATIONS ====== *#
# Detect current shell
if [ -n "$BASH_VERSION" ]; then
  CURRENT_SHELL="bash"
elif [ -n "$ZSH_VERSION" ]; then
  CURRENT_SHELL="zsh"
elif [ -n "$FISH_VERSION" ]; then
  CURRENT_SHELL="fish"
else
  CURRENT_SHELL="unknown"
fi

export CURRENT_SHELL

# Add ~/.local/bin to PATH if not already present
case ":$PATH:" in
  *":$HOME/.local/bin:"*) ;;
  *) export PATH="$HOME/.local/bin:$PATH" ;;
esac

# Set paths for shell-specific files in ~/.local/share/dotrun/
DOTRUN_SHARED="${HOME}/.local/share/dotrun"
SHELL_COMPLETION="${DOTRUN_SHARED}/shell/${CURRENT_SHELL}/dr_completion"
SHELL_ALIASES="${DOTRUN_SHARED}/shell/${CURRENT_SHELL}/aliases.sh"
SHELL_CONFIGS="${DOTRUN_SHARED}/shell/${CURRENT_SHELL}/configs.sh"

# Set completion file extension based on shell
# For bash, detect if ble.sh is loaded and use enhanced completion
if [[ $CURRENT_SHELL == "bash" ]]; then
  if [[ -n "${BLE_VERSION-}" ]]; then
    # [[ ! ${BLE_VERSION-} ]] || ble-attach
    # ble.sh is loaded - use enhanced completion with colors
    SHELL_COMPLETION="${SHELL_COMPLETION}_ble.sh"
  else
    # Standard bash - use basic completion
    SHELL_COMPLETION="${SHELL_COMPLETION}.bash"
  fi
elif [[ $CURRENT_SHELL == "zsh" ]]; then
  SHELL_COMPLETION="${SHELL_COMPLETION}.zsh"
elif [[ $CURRENT_SHELL == "fish" ]]; then
  SHELL_COMPLETION="${SHELL_COMPLETION}.fish"
fi

#! 1st - Source configs loader
if [ -f "$SHELL_CONFIGS" ]; then
  source "$SHELL_CONFIGS"
fi

#! 2nd - Source aliases loader
if [ -f "$SHELL_ALIASES" ]; then
  source "$SHELL_ALIASES"
fi

#! 3rd - Load completion
if [[ $CURRENT_SHELL == "zsh" ]]; then
  # Zsh: Use fpath-based discovery for universal plugin manager compatibility.
  # Works with oh-my-zsh, zinit, sheldon, or manual compinit.
  #
  # 1. Add completions dir to fpath (compinit scans this for _dr)
  # 2. Source the completion file (makes _dr available before compinit runs)
  # 3. Set up a self-cleaning precmd hook that ensures compdef registration
  #    survives turbo-mode plugin managers that reinitialize compinit
  ZSH_COMPLETIONS_DIR="${DOTRUN_SHARED}/shell/zsh/completions"
  if [[ -d "$ZSH_COMPLETIONS_DIR" ]]; then
    fpath=("$ZSH_COMPLETIONS_DIR" $fpath)
  fi
  if [[ -f "$SHELL_COMPLETION" ]]; then
    source "$SHELL_COMPLETION"
  fi
  # Ensure compdef registration — handles all timing scenarios:
  # - compinit already ran → register immediately
  # - compinit runs later (turbo mode) → precmd hook retries until registered
  _dr_ensure_completion() {
    # Already registered, clean up
    if [[ "${_comps[dr]}" == "_dr" ]]; then
      precmd_functions=(${precmd_functions:#_dr_ensure_completion})
      unfunction _dr_ensure_completion 2>/dev/null
      return
    fi
    # compdef available and _dr loaded → register now
    if (( $+functions[compdef] )) && (( $+functions[_dr] )); then
      compdef _dr dr 2>/dev/null
      precmd_functions=(${precmd_functions:#_dr_ensure_completion})
      unfunction _dr_ensure_completion 2>/dev/null
    fi
  }
  precmd_functions+=(_dr_ensure_completion)
else
  # Bash/Fish: source the completion file directly
  if [ -f "$SHELL_COMPLETION" ]; then
    source "$SHELL_COMPLETION"
  fi
fi
